<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Product Dispatch Input Form</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6; /* Light gray background */
        }
    </style>
</head>
<body class="p-4 sm:p-6 md:p-8">

    <div class="max-w-4xl mx-auto bg-white p-6 sm:p-8 rounded-lg shadow-xl border border-gray-200">
        <h1 class="text-3xl sm:text-4xl font-bold text-gray-800 mb-6 text-center">แบบฟอร์มบันทึกการเบิกสินค้า (Product Dispatch Input Form)</h1>
        <p class="text-gray-600 text-center mb-8">
            กรอกรายละเอียดการเบิกสินค้าจากสมุดบันทึกของคุณ
        </p>

        <!-- IMPORTANT: action attribute updated to your n8n Webhook URL -->
        <form id="dispatchForm" class="grid grid-cols-1 md:grid-cols-2 gap-y-6 gap-x-8"
              action="https://n8n-apmhoydn.ap-southeast-1.clawcloudrun.com/webhook-test/88daf681-1ebd-4c43-a674-31133c587563" method="POST">

            <!-- Date -->
            <div>
                <label for="date" class="block text-sm font-medium text-gray-700 mb-1">วันที่ (ว.ด.ป.)</label>
                <input type="date" id="date" name="date"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                       required>
            </div>

            <!-- PK No. -->
            <div>
                <label for="pkNo" class="block text-sm font-medium text-gray-700 mb-1">เลขที่ PK</label>
                <input type="text" id="pkNo" name="pkNo" placeholder="เช่น 6806055"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                       required>
            </div>

            <!-- Item ID -->
            <div>
                <label for="itemId" class="block text-sm font-medium text-gray-700 mb-1">รหัสสินค้า (Item)</label>
                <input type="text" id="itemId" name="itemId" placeholder="เช่น 310002"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                       required>
            </div>

            <!-- Product Name -->
            <div>
                <label for="productName" class="block text-sm font-medium text-gray-700 mb-1">ชื่อสินค้า</label>
                <input type="text" id="productName" name="productName" placeholder="เช่น คาร์แมกซ์โกลด์"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                       required>
            </div>

            <!-- Description -->
            <div>
                <label for="description" class="block text-sm font-medium text-gray-700 mb-1">ชื่อสามัญ</label>
                <input type="text" id="description" name="description" placeholder="เช่น Diuron"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Size -->
            <div>
                <label for="size" class="block text-sm font-medium text-gray-700 mb-1">ขนาด</label>
                <input type="text" id="size" name="size" placeholder="เช่น 20*1000"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Quantity -->
            <div>
                <label for="quantity" class="block text-sm font-medium text-gray-700 mb-1">จำนวน</label>
                <input type="number" id="quantity" name="quantity" placeholder="เช่น 250"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                       min="0" required>
            </div>

            <!-- Unit -->
            <div>
                <label for="unit" class="block text-sm font-medium text-gray-700 mb-1">หน่วย</label>
                <input type="text" id="unit" name="unit" placeholder="เช่น ลัง"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Weight -->
            <div>
                <label for="weight" class="block text-sm font-medium text-gray-700 mb-1">น้ำหนัก</label>
                <input type="number" id="weight" name="weight" placeholder="เช่น 5000"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200"
                       min="0">
            </div>

            <!-- New Field: Weight Unit (หน่วยน้ำหนัก) -->
            <div>
                <label for="weightUnit" class="block text-sm font-medium text-gray-700 mb-1">หน่วยน้ำหนัก</label>
                <input type="text" id="weightUnit" name="weightUnit" placeholder="เช่น กก."
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Company -->
            <div>
                <label for="company" class="block text-sm font-medium text-gray-700 mb-1">บริษัท</label>
                <input type="text" id="company" name="company" placeholder="เช่น อดามา"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Department Head -->
            <div>
                <label for="deptHead" class="block text-sm font-medium text-gray-700 mb-1">หัวหน้าฝ่าย</label>
                <input type="text" id="deptHead" name="deptHead" placeholder="เช่น ชัยชนะ"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- New Field: Actual Production (ผลิตได้จริง) -->
            <div>
                <label for="actualProduction" class="block text-sm font-medium text-gray-700 mb-1">ผลิตได้จริง</label>
                <input type="text" id="actualProduction" name="actualProduction" placeholder="เช่น เหมา"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Remarks Group 1 -->
            <div>
                <label for="remarks1" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ (กลุ่ม 1)</label>
                <input type="text" id="remarks1" name="remarks1" placeholder="เช่น กลุ่ม 2"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Remarks Group 2 -->
            <div>
                <label for="remarks2" class="block text-sm font-medium text-gray-700 mb-1">หมายเหตุ (กลุ่ม 2)</label>
                <input type="text" id="remarks2" name="remarks2" placeholder=""
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Reference No. -->
            <div>
                <label for="refNo" class="block text-sm font-medium text-gray-700 mb-1">เลขที่อ้างอิง (หมายเหตุ!)</label>
                <input type="text" id="refNo" name="refNo" placeholder="เช่น CD-01079"
                       class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm focus:ring-blue-500 focus:border-blue-500 sm:text-sm transition-colors duration-200">
            </div>

            <!-- Submit Button -->
            <div class="md:col-span-2 flex justify-center mt-6">
                <button type="submit"
                        class="w-full sm:w-auto px-8 py-3 bg-blue-600 text-white font-semibold rounded-md shadow-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 transition-transform duration-200 transform hover:scale-105">
                    ส่งข้อมูลการเบิกสินค้า
                </button>
            </div>

        </form>

        <!-- Message Box for output - Added flex utilities for centering -->
        <div id="messageBox" class="hidden mt-8 p-4 rounded-md shadow-sm flex flex-col items-center text-center" role="alert">
            <p id="messageText" class="mb-2"></p> <!-- Added mb-2 for spacing -->
            <!-- Existing Re-enter Data Button -->
            <div class="flex space-x-4 mt-4"> <!-- Flex container for buttons -->
                <button id="reEnterButton" class="px-4 py-2 bg-gray-200 text-gray-700 font-semibold rounded-md hover:bg-gray-300 focus:outline-none focus:ring-2 focus:ring-gray-400 transition-colors duration-200 hidden">
                    กรอกข้อมูลใหม่
                </button>
                <!-- New Button: Send Report (ส่งรายงาน) -->
                <button id="sendReportButton" class="px-4 py-2 bg-purple-600 text-white font-semibold rounded-md shadow-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-purple-500 focus:ring-offset-2 transition-transform duration-200 transform hover:scale-105 hidden">
                    ส่งรายงาน
                </button>
            </div>
        </div>

    </div>

    <script>
        document.getElementById('dispatchForm').addEventListener('submit', function(event) {
            // Prevent default form submission to handle success message
            event.preventDefault(); 

            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const reEnterButton = document.getElementById('reEnterButton');
            const sendReportButton = document.getElementById('sendReportButton'); // Get the new button
            const form = event.target; // Reference to the form

            // Show submitting message
            messageText.textContent = 'กำลังส่งข้อมูลไปยัง Webhook ของ n8n...';
            messageBox.classList.remove('hidden');
            messageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700', 'bg-red-100', 'border-red-400', 'text-red-700');
            messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');
            reEnterButton.classList.add('hidden'); // Hide re-enter button during submission
            sendReportButton.classList.add('hidden'); // Hide send report button during submission

            // Create a new FormData object from the form
            const formData = new FormData(form);

            // Send the form data to the webhook using fetch API
            fetch(form.action, {
                method: 'POST',
                body: formData // Use FormData directly for multipart/form-data
            })
            .then(response => {
                if (response.ok) { // Check if the response status is 200-299
                    messageText.textContent = 'ส่งข้อมูลสำเร็จไปยัง n8n แล้ว!';
                    messageBox.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                    form.reset(); // Clear the form on success
                    reEnterButton.classList.remove('hidden'); // Show re-enter button
                    sendReportButton.classList.remove('hidden'); // Show send report button
                    return response.text(); // Or response.json() if your webhook returns JSON
                } else {
                    // Handle HTTP errors
                    return response.text().then(text => { // Get the error message from the response
                        throw new Error(`การส่งข้อมูลล้มเหลว. เซิร์ฟเวอร์ตอบกลับด้วยสถานะ: ${response.status}. ข้อความ: ${text}`);
                    });
                }
            })
            .catch(error => {
                console.error('ข้อผิดพลาดในการส่งฟอร์ม:', error);
                messageText.textContent = `ข้อผิดพลาด: ${error.message}. โปรดลองอีกครั้ง.`;
                messageBox.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700', 'bg-green-100', 'border-green-400', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
                reEnterButton.classList.remove('hidden'); // Show re-enter button on error
                sendReportButton.classList.remove('hidden'); // Show send report button on error
            });
        });

        // Event listener for the "Re-enter Data" button
        document.getElementById('reEnterButton').addEventListener('click', function() {
            const messageBox = document.getElementById('messageBox');
            messageBox.classList.add('hidden'); // Hide the message box
            document.getElementById('dispatchForm').reset(); // Clear the form
            const today = new Date(); // Re-set the date to today
            const yyyy = today.getFullYear(); 
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
            this.classList.add('hidden'); // Hide itself
            document.getElementById('sendReportButton').classList.add('hidden'); // Hide send report button
        });

        // Event listener for the "Send Report" button (now with webhook functionality)
        document.getElementById('sendReportButton').addEventListener('click', function() {
            const messageBox = document.getElementById('messageBox');
            const messageText = document.getElementById('messageText');
            const form = document.getElementById('dispatchForm'); // Get a reference to the form

            // Show submitting message for the report
            messageText.textContent = 'กำลังส่งรายงานไปยัง Webhook ของ n8n...';
            messageBox.classList.remove('hidden');
            messageBox.classList.remove('bg-green-100', 'border-green-400', 'text-green-700', 'bg-red-100', 'border-red-400', 'text-red-700');
            messageBox.classList.add('bg-blue-100', 'border-blue-400', 'text-blue-700');

            // Create a new FormData object from the form's current values
            const formData = new FormData(form);
            
            // Add a new field specifically for the report status
            formData.append('reportStatus', 'Finished'); // This is the new value you want to send

            // Send the form data to the webhook using fetch API
            fetch(form.action, { // Reusing the same webhook action URL as the main form submit
                method: 'POST',
                body: formData 
            })
            .then(response => {
                if (response.ok) {
                    messageText.textContent = 'รายงานถูกส่งสำเร็จแล้ว!';
                    messageBox.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700');
                    messageBox.classList.add('bg-green-100', 'border-green-400', 'text-green-700');
                } else {
                    return response.text().then(text => {
                        throw new Error(`การส่งรายงานล้มเหลว. เซิร์ฟเวอร์ตอบกลับด้วยสถานะ: ${response.status}. ข้อความ: ${text}`);
                    });
                }
            })
            .catch(error => {
                console.error('ข้อผิดพลาดในการส่งรายงาน:', error);
                messageText.textContent = `ข้อผิดพลาดในการส่งรายงาน: ${error.message}. โปรดลองอีกครั้ง.`;
                messageBox.classList.remove('bg-blue-100', 'border-blue-400', 'text-blue-700', 'bg-green-100', 'border-green-400', 'text-green-700');
                messageBox.classList.add('bg-red-100', 'border-red-400', 'text-red-700');
            });
            // Keep both buttons visible after the report is sent
            document.getElementById('reEnterButton').classList.remove('hidden'); 
            this.classList.remove('hidden'); 
        });


        // Optional: Pre-fill date with today's date on page load
        window.onload = function() {
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0'); // Months start at 0!
            const dd = String(today.getDate()).padStart(2, '0');
            document.getElementById('date').value = `${yyyy}-${mm}-${dd}`;
        };
    </script>
</body>
</html>
